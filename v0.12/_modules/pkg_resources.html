

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pkg_resources &mdash; MetPy 0.12</title>
  

  
  
    <link rel="shortcut icon" href="../_static/metpy_32x32.ico"/>
  
  
  
    <link rel="canonical" href="https://unidata.github.io/MetPy/latest/_modules/pkg_resources.html"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_override.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="MetPy 0.12" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MetPy
          

          
            
            <img src="../_static/metpy_150x150.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                
                  <div class="version-dropdown">
                    <select class="version-list" id="version-list">
                      <option value=''>0.12</option>
                      
                        
                          <option value="../latest">latest</option>
                        
                      
                        
                          <option value="../dev">dev</option>
                        
                      
                    </select>
                  </div>
                
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installguide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../startingguide.html">Getting Started with MetPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../units.html">Unit Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://unidata.github.io/python-training/gallery/gallery-home">Python Gallery (separate site)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">MetPy Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gempak.html">GEMPAK Conversion Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SUPPORT.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributors Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructureguide.html">Infrastructure Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing MetPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MetPy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>pkg_resources</li>
    
    
    <li class="source-link">
        
    </li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pkg_resources</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Package resource API</span>
<span class="sd">--------------------</span>

<span class="sd">A resource is a logical file contained within a package, or a logical</span>
<span class="sd">subdirectory thereof.  The package resource API expects resource names</span>
<span class="sd">to have their path parts separated with ``/``, *not* whatever the local</span>
<span class="sd">path separator is.  Do not use os.path operations to manipulate resource</span>
<span class="sd">names being passed into the API.</span>

<span class="sd">The package resource API is designed to work with normal filesystem packages,</span>
<span class="sd">.egg files, and unpacked .egg files.  It can also work in a limited way with</span>
<span class="sd">.zip files and with custom PEP 302 loaders that support the ``get_data()``</span>
<span class="sd">method.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">zipimport</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">plistlib</span>
<span class="kn">import</span> <span class="nn">email.parser</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">ntpath</span>
<span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">from</span> <span class="nn">pkgutil</span> <span class="kn">import</span> <span class="n">get_importer</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_imp</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Python 3.2 compatibility</span>
    <span class="kn">import</span> <span class="nn">imp</span> <span class="k">as</span> <span class="nn">_imp</span>

<span class="k">try</span><span class="p">:</span>
    <span class="ne">FileExistsError</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="ne">FileExistsError</span> <span class="o">=</span> <span class="ne">OSError</span>

<span class="kn">from</span> <span class="nn">pkg_resources.extern</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">pkg_resources.extern.six.moves</span> <span class="kn">import</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">filter</span>

<span class="c1"># capture these to bypass sandboxing</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">utime</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">rename</span><span class="p">,</span> <span class="n">unlink</span>
    <span class="n">WRITE_SUPPORT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># no write support, probably under GAE</span>
    <span class="n">WRITE_SUPPORT</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">os_open</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">split</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib.machinery</span> <span class="k">as</span> <span class="nn">importlib_machinery</span>
    <span class="c1"># access attribute to force import under delayed import mechanisms.</span>
    <span class="n">importlib_machinery</span><span class="o">.</span><span class="vm">__name__</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">importlib_machinery</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">pkg_resources.extern</span> <span class="kn">import</span> <span class="n">appdirs</span>
<span class="kn">from</span> <span class="nn">pkg_resources.extern</span> <span class="kn">import</span> <span class="n">packaging</span>
<span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pkg_resources.extern.packaging.version&#39;</span><span class="p">)</span>
<span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pkg_resources.extern.packaging.specifiers&#39;</span><span class="p">)</span>
<span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pkg_resources.extern.packaging.requirements&#39;</span><span class="p">)</span>
<span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pkg_resources.extern.packaging.markers&#39;</span><span class="p">)</span>


<span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>


<span class="k">if</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Python 3.5 or later is required&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
    <span class="c1"># Those builtin exceptions are only defined in Python 3</span>
    <span class="ne">PermissionError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="ne">NotADirectoryError</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># declare some globals that will be defined later to</span>
<span class="c1"># satisfy the linters.</span>
<span class="n">require</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">working_set</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">add_activation_listener</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resources_stream</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">cleanup_resources</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_dir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_stream</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">set_extraction_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_isdir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_string</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">iter_entry_points</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_listdir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_filename</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">resource_exists</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_distribution_finders</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_namespace_handlers</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_namespace_packages</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">PEP440Warning</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used when there is an issue with a version or specifier not complying with</span>
<span class="sd">    PEP 440.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">parse_version</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">InvalidVersion</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">LegacyVersion</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="n">_state_vars</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_declare_state</span><span class="p">(</span><span class="n">vartype</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">_state_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">vartype</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">__getstate__</span><span class="p">():</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_state_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;_sget_&#39;</span> <span class="o">+</span> <span class="n">v</span><span class="p">](</span><span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">g</span><span class="p">[</span><span class="s1">&#39;_sset_&#39;</span> <span class="o">+</span> <span class="n">_state_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]](</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="k">def</span> <span class="nf">_sget_dict</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_sset_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sget_object</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_sset_object</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="n">_sget_none</span> <span class="o">=</span> <span class="n">_sset_none</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_supported_platform</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return this platform&#39;s maximum compatible version.</span>

<span class="sd">    distutils.util.get_platform() normally reports the minimum version</span>
<span class="sd">    of macOS that would be required to *use* extensions produced by</span>
<span class="sd">    distutils.  But what we want when checking compatibility is to know the</span>
<span class="sd">    version of macOS that we are *running*.  To allow usage of packages that</span>
<span class="sd">    explicitly require a newer version of macOS, we must also know the</span>
<span class="sd">    current version of the OS.</span>

<span class="sd">    If this condition occurs for any other platform with a version in its</span>
<span class="sd">    platform strings, this function should be extended accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plat</span> <span class="o">=</span> <span class="n">get_build_platform</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">macosVersionString</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">plat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plat</span> <span class="o">=</span> <span class="s1">&#39;macosx-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_macos_vers</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># not macOS</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">plat</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Basic resource access and distribution/entry point discovery</span>
    <span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;run_script&#39;</span><span class="p">,</span> <span class="s1">&#39;get_provider&#39;</span><span class="p">,</span> <span class="s1">&#39;get_distribution&#39;</span><span class="p">,</span>
    <span class="s1">&#39;load_entry_point&#39;</span><span class="p">,</span> <span class="s1">&#39;get_entry_map&#39;</span><span class="p">,</span> <span class="s1">&#39;get_entry_info&#39;</span><span class="p">,</span>
    <span class="s1">&#39;iter_entry_points&#39;</span><span class="p">,</span>
    <span class="s1">&#39;resource_string&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_stream&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_filename&#39;</span><span class="p">,</span>
    <span class="s1">&#39;resource_listdir&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_exists&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_isdir&#39;</span><span class="p">,</span>

    <span class="c1"># Environmental control</span>
    <span class="s1">&#39;declare_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;working_set&#39;</span><span class="p">,</span> <span class="s1">&#39;add_activation_listener&#39;</span><span class="p">,</span>
    <span class="s1">&#39;find_distributions&#39;</span><span class="p">,</span> <span class="s1">&#39;set_extraction_path&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup_resources&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_default_cache&#39;</span><span class="p">,</span>

    <span class="c1"># Primary implementation classes</span>
    <span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;WorkingSet&#39;</span><span class="p">,</span> <span class="s1">&#39;ResourceManager&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Distribution&#39;</span><span class="p">,</span> <span class="s1">&#39;Requirement&#39;</span><span class="p">,</span> <span class="s1">&#39;EntryPoint&#39;</span><span class="p">,</span>

    <span class="c1"># Exceptions</span>
    <span class="s1">&#39;ResolutionError&#39;</span><span class="p">,</span> <span class="s1">&#39;VersionConflict&#39;</span><span class="p">,</span> <span class="s1">&#39;DistributionNotFound&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UnknownExtra&#39;</span><span class="p">,</span> <span class="s1">&#39;ExtractionError&#39;</span><span class="p">,</span>

    <span class="c1"># Warnings</span>
    <span class="s1">&#39;PEP440Warning&#39;</span><span class="p">,</span>

    <span class="c1"># Parsing functions and string utilities</span>
    <span class="s1">&#39;parse_requirements&#39;</span><span class="p">,</span> <span class="s1">&#39;parse_version&#39;</span><span class="p">,</span> <span class="s1">&#39;safe_name&#39;</span><span class="p">,</span> <span class="s1">&#39;safe_version&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_platform&#39;</span><span class="p">,</span> <span class="s1">&#39;compatible_platforms&#39;</span><span class="p">,</span> <span class="s1">&#39;yield_lines&#39;</span><span class="p">,</span> <span class="s1">&#39;split_sections&#39;</span><span class="p">,</span>
    <span class="s1">&#39;safe_extra&#39;</span><span class="p">,</span> <span class="s1">&#39;to_filename&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid_marker&#39;</span><span class="p">,</span> <span class="s1">&#39;evaluate_marker&#39;</span><span class="p">,</span>

    <span class="c1"># filesystem utilities</span>
    <span class="s1">&#39;ensure_directory&#39;</span><span class="p">,</span> <span class="s1">&#39;normalize_path&#39;</span><span class="p">,</span>

    <span class="c1"># Distribution &quot;precedence&quot; constants</span>
    <span class="s1">&#39;EGG_DIST&#39;</span><span class="p">,</span> <span class="s1">&#39;BINARY_DIST&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE_DIST&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECKOUT_DIST&#39;</span><span class="p">,</span> <span class="s1">&#39;DEVELOP_DIST&#39;</span><span class="p">,</span>

    <span class="c1"># &quot;Provider&quot; interfaces, implementations, and registration/lookup APIs</span>
    <span class="s1">&#39;IMetadataProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;IResourceProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;FileMetadata&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PathMetadata&#39;</span><span class="p">,</span> <span class="s1">&#39;EggMetadata&#39;</span><span class="p">,</span> <span class="s1">&#39;EmptyProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_provider&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NullProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;EggProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;DefaultProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;ZipProvider&#39;</span><span class="p">,</span>
    <span class="s1">&#39;register_finder&#39;</span><span class="p">,</span> <span class="s1">&#39;register_namespace_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;register_loader_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fixup_namespace_packages&#39;</span><span class="p">,</span> <span class="s1">&#39;get_importer&#39;</span><span class="p">,</span>

    <span class="c1"># Warnings</span>
    <span class="s1">&#39;PkgResourcesDeprecationWarning&#39;</span><span class="p">,</span>

    <span class="c1"># Deprecated/backward compatibility only</span>
    <span class="s1">&#39;run_main&#39;</span><span class="p">,</span> <span class="s1">&#39;AvailableDistributions&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">ResolutionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base for dependency resolution errors&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">VersionConflict</span><span class="p">(</span><span class="n">ResolutionError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An already-installed version conflicts with the requested version.</span>

<span class="sd">    Should be initialized with the installed Distribution and the requested</span>
<span class="sd">    Requirement.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{self.dist}</span><span class="s2"> is installed but </span><span class="si">{self.req}</span><span class="s2"> is required&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">req</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If required_by is non-empty, return a version of self that is a</span>
<span class="sd">        ContextualVersionConflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required_by</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">required_by</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">ContextualVersionConflict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ContextualVersionConflict</span><span class="p">(</span><span class="n">VersionConflict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A VersionConflict that accepts a third parameter, the set of the</span>
<span class="sd">    requirements that required the installed Distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_template</span> <span class="o">=</span> <span class="n">VersionConflict</span><span class="o">.</span><span class="n">_template</span> <span class="o">+</span> <span class="s1">&#39; by </span><span class="si">{self.required_by}</span><span class="s1">&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">required_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DistributionNotFound</span><span class="p">(</span><span class="n">ResolutionError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A requested distribution was not found&quot;&quot;&quot;</span>

    <span class="n">_template</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">{self.req}</span><span class="s2">&#39; distribution was not found &quot;</span>
                 <span class="s2">&quot;and is required by </span><span class="si">{self.requirers_str}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">req</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requirers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requirers_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirers</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;the application&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requirers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">UnknownExtra</span><span class="p">(</span><span class="n">ResolutionError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Distribution doesn&#39;t have an &quot;extra feature&quot; of the given name&quot;&quot;&quot;</span>


<span class="n">_provider_factories</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">PY_MAJOR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">)</span>
<span class="n">EGG_DIST</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">BINARY_DIST</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SOURCE_DIST</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">CHECKOUT_DIST</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DEVELOP_DIST</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


<span class="k">def</span> <span class="nf">register_loader_type</span><span class="p">(</span><span class="n">loader_type</span><span class="p">,</span> <span class="n">provider_factory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register `provider_factory` to make providers for `loader_type`</span>

<span class="sd">    `loader_type` is the type or class of a PEP 302 ``module.__loader__``,</span>
<span class="sd">    and `provider_factory` is a function that, passed a *module* object,</span>
<span class="sd">    returns an ``IResourceProvider`` for that module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_provider_factories</span><span class="p">[</span><span class="n">loader_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider_factory</span>


<span class="k">def</span> <span class="nf">get_provider</span><span class="p">(</span><span class="n">moduleOrReq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an IResourceProvider for the named module or requirement&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moduleOrReq</span><span class="p">,</span> <span class="n">Requirement</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">working_set</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">moduleOrReq</span><span class="p">)</span> <span class="ow">or</span> <span class="n">require</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">moduleOrReq</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">moduleOrReq</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">moduleOrReq</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">moduleOrReq</span><span class="p">]</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__loader__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_find_adapter</span><span class="p">(</span><span class="n">_provider_factories</span><span class="p">,</span> <span class="n">loader</span><span class="p">)(</span><span class="n">module</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_macos_vers</span><span class="p">(</span><span class="n">_cache</span><span class="o">=</span><span class="p">[]):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_cache</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">mac_ver</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># fallback for MacPorts</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="s1">&#39;/System/Library/CoreServices/SystemVersion.plist&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plist</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plistlib</span><span class="p">,</span> <span class="s1">&#39;readPlist&#39;</span><span class="p">):</span>
                    <span class="n">plist_content</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;ProductVersion&#39;</span> <span class="ow">in</span> <span class="n">plist_content</span><span class="p">:</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">plist_content</span><span class="p">[</span><span class="s1">&#39;ProductVersion&#39;</span><span class="p">]</span>

        <span class="n">_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_macos_arch</span><span class="p">(</span><span class="n">machine</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;PowerPC&#39;</span><span class="p">:</span> <span class="s1">&#39;ppc&#39;</span><span class="p">,</span> <span class="s1">&#39;Power_Macintosh&#39;</span><span class="p">:</span> <span class="s1">&#39;ppc&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">machine</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_build_platform</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return this platform&#39;s string for platform-specific distributions</span>

<span class="sd">    XXX Currently this is the same as ``distutils.util.get_platform()``, but it</span>
<span class="sd">    needs some hacks for Linux and macOS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sysconfig</span> <span class="kn">import</span> <span class="n">get_platform</span>

    <span class="n">plat</span> <span class="o">=</span> <span class="n">get_platform</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plat</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;macosx-&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">_macos_vers</span><span class="p">()</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;macosx-</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">_macos_arch</span><span class="p">(</span><span class="n">machine</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># if someone is running a non-Mac darwin system, this will fall</span>
            <span class="c1"># through to the default implementation</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">plat</span>


<span class="n">macosVersionString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;macosx-(\d+)\.(\d+)-(.*)&quot;</span><span class="p">)</span>
<span class="n">darwinVersionString</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;darwin-(\d+)\.(\d+)\.(\d+)-(.*)&quot;</span><span class="p">)</span>
<span class="c1"># XXX backward compat</span>
<span class="n">get_platform</span> <span class="o">=</span> <span class="n">get_build_platform</span>


<span class="k">def</span> <span class="nf">compatible_platforms</span><span class="p">(</span><span class="n">provided</span><span class="p">,</span> <span class="n">required</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Can code for the `provided` platform run on the `required` platform?</span>

<span class="sd">    Returns true if either platform is ``None``, or the platforms are equal.</span>

<span class="sd">    XXX Needs compatibility checks for Linux and other unixy OSes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">provided</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">required</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">provided</span> <span class="o">==</span> <span class="n">required</span><span class="p">:</span>
        <span class="c1"># easy case</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># macOS special cases</span>
    <span class="n">reqMac</span> <span class="o">=</span> <span class="n">macosVersionString</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reqMac</span><span class="p">:</span>
        <span class="n">provMac</span> <span class="o">=</span> <span class="n">macosVersionString</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">provided</span><span class="p">)</span>

        <span class="c1"># is this a Mac package?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provMac</span><span class="p">:</span>
            <span class="c1"># this is backwards compatibility for packages built before</span>
            <span class="c1"># setuptools 0.6. All packages built after this point will</span>
            <span class="c1"># use the new macOS designation.</span>
            <span class="n">provDarwin</span> <span class="o">=</span> <span class="n">darwinVersionString</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">provided</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provDarwin</span><span class="p">:</span>
                <span class="n">dversion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">provDarwin</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">macosversion</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reqMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reqMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dversion</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">macosversion</span> <span class="o">&gt;=</span> <span class="s2">&quot;10.3&quot;</span> <span class="ow">or</span> \
                        <span class="n">dversion</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">macosversion</span> <span class="o">&gt;=</span> <span class="s2">&quot;10.4&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># egg isn&#39;t macOS or legacy darwin</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># are they the same major version and machine type?</span>
        <span class="k">if</span> <span class="n">provMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">reqMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="n">provMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">reqMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># is the required OS major update &gt;= the provided one?</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">provMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">reqMac</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># XXX Linux and other platforms&#39; special cases should go here</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="n">dist_spec</span><span class="p">,</span> <span class="n">script_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate distribution `dist_spec` and run its `script_name` script&quot;&quot;&quot;</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span>
    <span class="n">ns</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">require</span><span class="p">(</span><span class="n">dist_spec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>


<span class="c1"># backward compatibility</span>
<span class="n">run_main</span> <span class="o">=</span> <span class="n">run_script</span>


<span class="k">def</span> <span class="nf">get_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a current distribution object for a Requirement or string&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">Requirement</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected string, Requirement, or Distribution&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span>


<span class="k">def</span> <span class="nf">load_entry_point</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return `name` entry point of `group` for `dist` or raise ImportError&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">load_entry_point</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_entry_map</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the entry point map for `group`, or the full entry map&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">get_entry_map</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_entry_info</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the EntryPoint object for `group`+`name`, or ``None``&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">get_entry_info</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IMetadataProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">has_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the package&#39;s distribution contain the named metadata?&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The named metadata resource as a string&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_metadata_lines</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield named metadata resource as list of non-blank non-comment lines</span>

<span class="sd">       Leading and trailing whitespace is stripped from each line, and lines</span>
<span class="sd">       with ``#`` as the first non-blank character are omitted.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">metadata_isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the named metadata a directory?  (like ``os.path.isdir()``)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">metadata_listdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of metadata names in the directory (like ``os.listdir()``)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the named script in the supplied namespace dictionary&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">IResourceProvider</span><span class="p">(</span><span class="n">IMetadataProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object that provides access to package resources&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_resource_filename</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a true filesystem path for `resource_name`</span>

<span class="sd">        `manager` must be an ``IResourceManager``&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_resource_stream</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a readable file-like object for `resource_name`</span>

<span class="sd">        `manager` must be an ``IResourceManager``&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_resource_string</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string containing the contents of `resource_name`</span>

<span class="sd">        `manager` must be an ``IResourceManager``&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the package contain the named resource?&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">resource_isdir</span><span class="p">(</span><span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the named resource a directory?  (like ``os.path.isdir()``)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">resource_listdir</span><span class="p">(</span><span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of resource names in the directory (like ``os.listdir()``)&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">WorkingSet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A collection of active distributions on sys.path (or a similar list)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create working set from list of path entries (default=sys.path)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">entries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_master</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the master working set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">__main__</span> <span class="kn">import</span> <span class="n">__requires__</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># The main program does not list any requirements</span>
            <span class="k">return</span> <span class="n">ws</span>

        <span class="c1"># ensure the requirements are met</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">__requires__</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VersionConflict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build_from_requirements</span><span class="p">(</span><span class="n">__requires__</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ws</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_from_requirements</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">req_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a working set from a requirement spec. Rewrites sys.path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># try it without defaults already on sys.path</span>
        <span class="c1"># by starting with an empty path</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([])</span>
        <span class="n">reqs</span> <span class="o">=</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">req_spec</span><span class="p">)</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">reqs</span><span class="p">,</span> <span class="n">Environment</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">:</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

        <span class="c1"># add any missing entries from sys.path</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ws</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="n">ws</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="c1"># then copy back to sys.path</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">entries</span>
        <span class="k">return</span> <span class="n">ws</span>

    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a path item to ``.entries``, finding any distributions on it</span>

<span class="sd">        ``find_distributions(entry, True)`` is used to find distributions</span>
<span class="sd">        corresponding to the path entry, and they are added.  `entry` is</span>
<span class="sd">        always appended to ``.entries``, even if it is already present.</span>
<span class="sd">        (This is because ``sys.path`` can contain the same value more than</span>
<span class="sd">        once, and the ``.entries`` of the ``sys.path`` WorkingSet should always</span>
<span class="sd">        equal ``sys.path``.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">find_distributions</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if `dist` is the active distribution for its project&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find a distribution matching requirement `req`</span>

<span class="sd">        If there is an active distribution for the requested project, this</span>
<span class="sd">        returns it as long as it meets the version requirement specified by</span>
<span class="sd">        `req`.  But, if there is an active distribution for the project and it</span>
<span class="sd">        does *not* meet the `req` requirement, ``VersionConflict`` is raised.</span>
<span class="sd">        If there is no active distribution for the requested project, ``None``</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
            <span class="c1"># XXX add more info</span>
            <span class="k">raise</span> <span class="n">VersionConflict</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">iter_entry_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield entry point objects from `group` matching `name`</span>

<span class="sd">        If `name` is None, yields all entry points in `group` from all</span>
<span class="sd">        distributions in the working set, otherwise only ones matching</span>
<span class="sd">        both `group` and `name` are yielded (in distribution order).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">entry</span>
            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_entry_map</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requires</span><span class="p">,</span> <span class="n">script_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locate distribution for `requires` and run `script_name` script&quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">requires</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield distributions for non-duplicate projects in the working set</span>

<span class="sd">        The yield order is the order in which the items&#39; path entries were</span>
<span class="sd">        added to the working set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="p">:</span>
                <span class="c1"># workaround a cache issue</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `dist` to working set, associated with `entry`</span>

<span class="sd">        If `entry` is unspecified, it defaults to the ``.location`` of `dist`.</span>
<span class="sd">        On exit from this routine, `entry` is added to the end of the working</span>
<span class="sd">        set&#39;s ``.entries`` (if it wasn&#39;t already present).</span>

<span class="sd">        `dist` is only added to the working set if it&#39;s for a project that</span>
<span class="sd">        doesn&#39;t already have a distribution in the set, unless `replace=True`.</span>
<span class="sd">        If it&#39;s added, any callbacks registered with the ``subscribe()`` method</span>
<span class="sd">        will be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">insert_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">location</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">keys2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="p">:</span>
            <span class="c1"># ignore hidden distros</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys2</span><span class="p">:</span>
            <span class="n">keys2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_added_new</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">replace_conflicting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all distributions needed to (recursively) meet `requirements`</span>

<span class="sd">        `requirements` must be a sequence of ``Requirement`` objects.  `env`,</span>
<span class="sd">        if supplied, should be an ``Environment`` instance.  If</span>
<span class="sd">        not supplied, it defaults to all distributions available within any</span>
<span class="sd">        entry or distribution in the working set.  `installer`, if supplied,</span>
<span class="sd">        will be invoked with each requirement that cannot be met by an</span>
<span class="sd">        already-installed distribution; it should return a ``Distribution`` or</span>
<span class="sd">        ``None``.</span>

<span class="sd">        Unless `replace_conflicting=True`, raises a VersionConflict exception</span>
<span class="sd">        if</span>
<span class="sd">        any requirements are found on the path that have the correct name but</span>
<span class="sd">        the wrong version.  Otherwise, if an `installer` is supplied it will be</span>
<span class="sd">        invoked to obtain the correct version of the requirement and activate</span>
<span class="sd">        it.</span>

<span class="sd">        `extras` is a list of the extras to be used with these requirements.</span>
<span class="sd">        This is important because extra requirements may look like `my_req;</span>
<span class="sd">        extra = &quot;my_extra&quot;`, which would otherwise be interpreted as a purely</span>
<span class="sd">        optional requirement.  Instead, we want to be able to assert that these</span>
<span class="sd">        requirements are truly required.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set up the stack</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">requirements</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># set of processed requirements</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key -&gt; dist</span>
        <span class="n">best</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">to_activate</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">req_extras</span> <span class="o">=</span> <span class="n">_ReqExtras</span><span class="p">()</span>

        <span class="c1"># Mapping of requirement to set of distributions that required it;</span>
        <span class="c1"># useful for reporting info about conflicts.</span>
        <span class="n">required_by</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="c1"># process dependencies breadth-first</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">requirements</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">processed</span><span class="p">:</span>
                <span class="c1"># Ignore cyclic or redundant dependencies</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">req_extras</span><span class="o">.</span><span class="n">markers_pass</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">extras</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">dist</span> <span class="o">=</span> <span class="n">best</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Find the best distribution and add it to the map</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span> <span class="ow">and</span> <span class="n">replace_conflicting</span><span class="p">):</span>
                    <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span>
                    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Use an empty environment and workingset to avoid</span>
                            <span class="c1"># any further conflicts with the conflicting</span>
                            <span class="c1"># distribution</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">([])</span>
                            <span class="n">ws</span> <span class="o">=</span> <span class="n">WorkingSet</span><span class="p">([])</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">best_match</span><span class="p">(</span>
                        <span class="n">req</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">installer</span><span class="p">,</span>
                        <span class="n">replace_conflicting</span><span class="o">=</span><span class="n">replace_conflicting</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">requirers</span> <span class="o">=</span> <span class="n">required_by</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">DistributionNotFound</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">requirers</span><span class="p">)</span>
                <span class="n">to_activate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
                <span class="c1"># Oops, the &quot;best&quot; so far conflicts with a dependency</span>
                <span class="n">dependent_req</span> <span class="o">=</span> <span class="n">required_by</span><span class="p">[</span><span class="n">req</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">VersionConflict</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">dependent_req</span><span class="p">)</span>

            <span class="c1"># push the new requirements onto the stack</span>
            <span class="n">new_requirements</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">extras</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">requirements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_requirements</span><span class="p">)</span>

            <span class="c1"># Register the new requirements needed by req</span>
            <span class="k">for</span> <span class="n">new_requirement</span> <span class="ow">in</span> <span class="n">new_requirements</span><span class="p">:</span>
                <span class="n">required_by</span><span class="p">[</span><span class="n">new_requirement</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">project_name</span><span class="p">)</span>
                <span class="n">req_extras</span><span class="p">[</span><span class="n">new_requirement</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">extras</span>

            <span class="n">processed</span><span class="p">[</span><span class="n">req</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># return list of distros to activate</span>
        <span class="k">return</span> <span class="n">to_activate</span>

    <span class="k">def</span> <span class="nf">find_plugins</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">plugin_env</span><span class="p">,</span> <span class="n">full_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all activatable distributions in `plugin_env`</span>

<span class="sd">        Example usage::</span>

<span class="sd">            distributions, errors = working_set.find_plugins(</span>
<span class="sd">                Environment(plugin_dirlist)</span>
<span class="sd">            )</span>
<span class="sd">            # add plugins+libs to sys.path</span>
<span class="sd">            map(working_set.add, distributions)</span>
<span class="sd">            # display errors</span>
<span class="sd">            print(&#39;Could not load&#39;, errors)</span>

<span class="sd">        The `plugin_env` should be an ``Environment`` instance that contains</span>
<span class="sd">        only distributions that are in the project&#39;s &quot;plugin directory&quot; or</span>
<span class="sd">        directories. The `full_env`, if supplied, should be an ``Environment``</span>
<span class="sd">        contains all currently-available distributions.  If `full_env` is not</span>
<span class="sd">        supplied, one is created automatically from the ``WorkingSet`` this</span>
<span class="sd">        method is called on, which will typically mean that every directory on</span>
<span class="sd">        ``sys.path`` will be scanned for distributions.</span>

<span class="sd">        `installer` is a standard installer callback as used by the</span>
<span class="sd">        ``resolve()`` method. The `fallback` flag indicates whether we should</span>
<span class="sd">        attempt to resolve older versions of a plugin if the newest version</span>
<span class="sd">        cannot be resolved.</span>

<span class="sd">        This method returns a 2-tuple: (`distributions`, `error_info`), where</span>
<span class="sd">        `distributions` is a list of the distributions found in `plugin_env`</span>
<span class="sd">        that were loadable, along with any other distributions that are needed</span>
<span class="sd">        to resolve their dependencies.  `error_info` is a dictionary mapping</span>
<span class="sd">        unloadable plugin distributions to an exception instance describing the</span>
<span class="sd">        error that occurred. Usually this will be a ``DistributionNotFound`` or</span>
<span class="sd">        ``VersionConflict`` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plugin_projects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plugin_env</span><span class="p">)</span>
        <span class="c1"># scan project names in alphabetic order</span>
        <span class="n">plugin_projects</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">error_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">distributions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">full_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
            <span class="n">env</span> <span class="o">+=</span> <span class="n">plugin_env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">full_env</span> <span class="o">+</span> <span class="n">plugin_env</span>

        <span class="n">shadow_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">([])</span>
        <span class="c1"># put all our entries in shadow_set</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">shadow_set</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">plugin_projects</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">plugin_env</span><span class="p">[</span><span class="n">project_name</span><span class="p">]:</span>

                <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">as_requirement</span><span class="p">()]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resolvees</span> <span class="o">=</span> <span class="n">shadow_set</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">installer</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">ResolutionError</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
                    <span class="c1"># save error info</span>
                    <span class="n">error_info</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">fallback</span><span class="p">:</span>
                        <span class="c1"># try the next older version of project</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># give up on this project, keep going</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">shadow_set</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">resolvees</span><span class="p">))</span>
                    <span class="n">distributions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">resolvees</span><span class="p">))</span>

                    <span class="c1"># success, no need to try any more versions of this project</span>
                    <span class="k">break</span>

        <span class="n">distributions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">distributions</span><span class="p">)</span>
        <span class="n">distributions</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">error_info</span>

    <span class="k">def</span> <span class="nf">require</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">requirements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that distributions matching `requirements` are activated</span>

<span class="sd">        `requirements` must be a string or a (possibly-nested) sequence</span>
<span class="sd">        thereof, specifying the distributions and versions required.  The</span>
<span class="sd">        return value is a sequence of the distributions that needed to be</span>
<span class="sd">        activated to fulfill the requirements; all relevant distributions are</span>
<span class="sd">        included, even if they were already activated in this working set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">parse_requirements</span><span class="p">(</span><span class="n">requirements</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">needed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">needed</span>

    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoke `callback` for all distributions</span>

<span class="sd">        If `existing=True` (default),</span>
<span class="sd">        call on all existing ones, as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_added_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[:]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e_k_b_c</span><span class="p">):</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">by_key</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="n">e_k_b_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by_key</span> <span class="o">=</span> <span class="n">by_key</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">[:]</span>


<span class="k">class</span> <span class="nc">_ReqExtras</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map each requirement to the extras that demanded it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">markers_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate markers for req against each extra that</span>
<span class="sd">        demanded it.</span>

<span class="sd">        Return False if the req has a marker and fails</span>
<span class="sd">        evaluation. Otherwise, return True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_evals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">({</span><span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="n">extra</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">extras</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">extra_evals</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Environment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Searchable snapshot of distributions on a search path&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">search_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="n">get_supported_platform</span><span class="p">(),</span>
            <span class="n">python</span><span class="o">=</span><span class="n">PY_MAJOR</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Snapshot distributions available on a search path</span>

<span class="sd">        Any distributions found on `search_path` are added to the environment.</span>
<span class="sd">        `search_path` should be a sequence of ``sys.path`` items.  If not</span>
<span class="sd">        supplied, ``sys.path`` is used.</span>

<span class="sd">        `platform` is an optional string specifying the name of the platform</span>
<span class="sd">        that platform-specific distributions must be compatible with.  If</span>
<span class="sd">        unspecified, it defaults to the current platform.  `python` is an</span>
<span class="sd">        optional string naming the desired version of Python (e.g. ``&#39;3.6&#39;``);</span>
<span class="sd">        it defaults to the current version.</span>

<span class="sd">        You may explicitly set `platform` (and/or `python`) to ``None`` if you</span>
<span class="sd">        wish to map *all* distributions, not just those compatible with the</span>
<span class="sd">        running platform or Python version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python</span> <span class="o">=</span> <span class="n">python</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">search_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is distribution `dist` acceptable for this environment?</span>

<span class="sd">        The distribution must match the platform and python version</span>
<span class="sd">        requirements specified when this environment was created, or False</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">py_compat</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">python</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">dist</span><span class="o">.</span><span class="n">py_version</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">dist</span><span class="o">.</span><span class="n">py_version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">python</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">py_compat</span> <span class="ow">and</span> <span class="n">compatible_platforms</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `dist` from the environment&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distmap</span><span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan `search_path` for distributions usable in this environment</span>

<span class="sd">        Any distributions found are added to the environment.</span>
<span class="sd">        `search_path` should be a sequence of ``sys.path`` items.  If not</span>
<span class="sd">        supplied, ``sys.path`` is used.  Only distributions conforming to</span>
<span class="sd">        the platform/python version defined at initialization are added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">search_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">search_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">search_path</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">find_distributions</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a newest-to-oldest list of distributions for `project_name`</span>

<span class="sd">        Uses case-insensitive `project_name` comparison, assuming all the</span>
<span class="sd">        project&#39;s distributions use their project&#39;s name converted to all</span>
<span class="sd">        lowercase as their key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distribution_key</span> <span class="o">=</span> <span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">distribution_key</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `dist` if we ``can_add()`` it and it has not already been added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_add</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">has_version</span><span class="p">():</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distmap</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">:</span>
                <span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                <span class="n">dists</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;hashcmp&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">best_match</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">working_set</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace_conflicting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find distribution best matching `req` and usable on `working_set`</span>

<span class="sd">        This calls the ``find(req)`` method of the `working_set` to see if a</span>
<span class="sd">        suitable distribution is already active.  (This may raise</span>
<span class="sd">        ``VersionConflict`` if an unsuitable version of the project is already</span>
<span class="sd">        active in the specified `working_set`.)  If a suitable distribution</span>
<span class="sd">        isn&#39;t active, this method returns the newest distribution in the</span>
<span class="sd">        environment that meets the ``Requirement`` in `req`.  If no suitable</span>
<span class="sd">        distribution is found, and `installer` is supplied, then the result of</span>
<span class="sd">        calling the environment&#39;s ``obtain(req, installer)`` method will be</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">VersionConflict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replace_conflicting</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dist</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dist</span>
        <span class="c1"># try to download/install</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obtain</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">installer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">obtain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirement</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain a distribution matching `requirement` (e.g. via download)</span>

<span class="sd">        Obtain a distro that matches requirement (e.g. via download).  In the</span>
<span class="sd">        base ``Environment`` class, this routine just returns</span>
<span class="sd">        ``installer(requirement)``, unless `installer` is None, in which case</span>
<span class="sd">        None is returned instead.  This method is a hook that allows subclasses</span>
<span class="sd">        to attempt other ways of obtaining a distribution before falling back</span>
<span class="sd">        to the `installer` argument.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">installer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">installer</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield the unique project names of the available distributions&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distmap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">key</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In-place addition of a distribution or environment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Environment</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">other</span><span class="p">[</span><span class="n">project</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add </span><span class="si">%r</span><span class="s2"> to environment&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">other</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an environment or distribution to an environment&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">([],</span> <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">+=</span> <span class="n">env</span>
        <span class="k">return</span> <span class="n">new</span>


<span class="c1"># XXX backward compatibility</span>
<span class="n">AvailableDistributions</span> <span class="o">=</span> <span class="n">Environment</span>


<span class="k">class</span> <span class="nc">ExtractionError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An error occurred extracting a resource</span>

<span class="sd">    The following attributes are available from instances of this exception:</span>

<span class="sd">    manager</span>
<span class="sd">        The resource manager that raised this exception</span>

<span class="sd">    cache_path</span>
<span class="sd">        The base directory for resource extraction</span>

<span class="sd">    original_error</span>
<span class="sd">        The exception instance that caused extraction to fail</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ResourceManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage resource extraction and packages&quot;&quot;&quot;</span>
    <span class="n">extraction_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_files</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the named resource exist?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">has_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resource_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the named resource an existing directory?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">resource_isdir</span><span class="p">(</span>
            <span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">resource_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a true filesystem path for specified resource&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">get_resource_filename</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">resource_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a readable file-like object for specified resource&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">get_resource_stream</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">resource_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified resource as a string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">get_resource_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">resource_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_or_requirement</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List the contents of the named resource directory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">package_or_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">resource_listdir</span><span class="p">(</span>
            <span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">extraction_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Give an error message for problems extracting file(s)&quot;&quot;&quot;</span>

        <span class="n">old_exc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_path</span> <span class="ow">or</span> <span class="n">get_default_cache</span><span class="p">()</span>

        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Can&#39;t extract file(s) to egg cache</span>

<span class="s2">            The following error occurred while trying to extract file(s)</span>
<span class="s2">            to the Python egg cache:</span>

<span class="s2">              </span><span class="si">{old_exc}</span><span class="s2"></span>

<span class="s2">            The Python egg cache directory is currently set to:</span>

<span class="s2">              </span><span class="si">{cache_path}</span><span class="s2"></span>

<span class="s2">            Perhaps your account does not have write access to this directory?</span>
<span class="s2">            You can change the cache directory by setting the PYTHON_EGG_CACHE</span>
<span class="s2">            environment variable to point to an accessible directory.</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">ExtractionError</span><span class="p">(</span><span class="n">tmpl</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
        <span class="n">err</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">err</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache_path</span>
        <span class="n">err</span><span class="o">.</span><span class="n">original_error</span> <span class="o">=</span> <span class="n">old_exc</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">get_cache_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive_name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Return absolute location in cache for `archive_name` and `names`</span>

<span class="sd">        The parent directory of the resulting path will be created if it does</span>
<span class="sd">        not already exist.  `archive_name` should be the base filename of the</span>
<span class="sd">        enclosing egg (which may not be the name of the enclosing zipfile!),</span>
<span class="sd">        including its &quot;.egg&quot; extension.  `names`, if provided, should be a</span>
<span class="sd">        sequence of path name parts &quot;under&quot; the egg&#39;s extraction location.</span>

<span class="sd">        This method should only be called by resource providers that need to</span>
<span class="sd">        obtain an extraction location, and only for names they intend to</span>
<span class="sd">        extract, as it tracks the generated names for possible cleanup later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extract_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_path</span> <span class="ow">or</span> <span class="n">get_default_cache</span><span class="p">()</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_path</span><span class="p">,</span> <span class="n">archive_name</span> <span class="o">+</span> <span class="s1">&#39;-tmp&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_bypass_ensure_directory</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction_error</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_unsafe_extraction_path</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cached_files</span><span class="p">[</span><span class="n">target_path</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">target_path</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_warn_unsafe_extraction_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the default extraction path is overridden and set to an insecure</span>
<span class="sd">        location, such as /tmp, it opens up an opportunity for an attacker to</span>
<span class="sd">        replace an extracted file with an unauthorized payload. Warn the user</span>
<span class="sd">        if a known insecure location is used.</span>

<span class="sd">        See Distribute #375 for more details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;windir&#39;</span><span class="p">]):</span>
            <span class="c1"># On Windows, permissions are generally restrictive by default</span>
            <span class="c1">#  and temp directories are not writable by other users, so</span>
            <span class="c1">#  bypass the warning.</span>
            <span class="k">return</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWOTH</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWGRP</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Extraction path is writable by group/others &quot;</span>
                <span class="s2">&quot;and vulnerable to attack when &quot;</span>
                <span class="s2">&quot;used with get_resource_filename (</span><span class="si">{path}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;Consider a more secure &quot;</span>
                <span class="s2">&quot;location (set with .set_extraction_path or the &quot;</span>
                <span class="s2">&quot;PYTHON_EGG_CACHE environment variable).&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempname</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform any platform-specific postprocessing of `tempname`</span>

<span class="sd">        This is where Mac header rewrites should be done; other platforms don&#39;t</span>
<span class="sd">        have anything special they should do.</span>

<span class="sd">        Resource providers should call this method ONLY after successfully</span>
<span class="sd">        extracting a compressed resource.  They must NOT call it on resources</span>
<span class="sd">        that are already in the filesystem.</span>

<span class="sd">        `tempname` is the current (temporary) name of the file, and `filename`</span>
<span class="sd">        is the name it will be renamed to by the caller after this routine</span>
<span class="sd">        returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
            <span class="c1"># Make the resource executable</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">tempname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">|</span> <span class="mo">0o555</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mo">0o7777</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tempname</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_extraction_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the base path where resources will be extracted to, if needed.</span>

<span class="sd">        If you do not call this routine before any extractions take place, the</span>
<span class="sd">        path defaults to the return value of ``get_default_cache()``.  (Which</span>
<span class="sd">        is based on the ``PYTHON_EGG_CACHE`` environment variable, with various</span>
<span class="sd">        platform-specific fallbacks.  See that routine&#39;s documentation for more</span>
<span class="sd">        details.)</span>

<span class="sd">        Resources are extracted to subdirectories of this path based upon</span>
<span class="sd">        information given by the ``IResourceProvider``.  You may set this to a</span>
<span class="sd">        temporary directory, but then you must call ``cleanup_resources()`` to</span>
<span class="sd">        delete the extracted files when done.  There is no guarantee that</span>
<span class="sd">        ``cleanup_resources()`` will be able to remove all extracted files.</span>

<span class="sd">        (Note: you may not change the extraction path for a given resource</span>
<span class="sd">        manager once resources have been extracted, unless you first call</span>
<span class="sd">        ``cleanup_resources()``.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t change extraction path, files already extracted&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">cleanup_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all extracted resource files and directories, returning a list</span>
<span class="sd">        of the file and directory names that could not be successfully removed.</span>
<span class="sd">        This function does not have any concurrency protection, so it should</span>
<span class="sd">        generally only be called when the extraction path is a temporary</span>
<span class="sd">        directory exclusive to a single process.  This method is not</span>
<span class="sd">        automatically called; you must call it explicitly or register it as an</span>
<span class="sd">        ``atexit`` function if you wish to ensure cleanup of a temporary</span>
<span class="sd">        directory used for extractions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># XXX</span>


<span class="k">def</span> <span class="nf">get_default_cache</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the ``PYTHON_EGG_CACHE`` environment variable</span>
<span class="sd">    or a platform-relevant user cache dir for an app</span>
<span class="sd">    named &quot;Python-Eggs&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PYTHON_EGG_CACHE&#39;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">appdirs</span><span class="o">.</span><span class="n">user_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;Python-Eggs&#39;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">safe_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert an arbitrary string to a standard distribution name</span>

<span class="sd">    Any runs of non-alphanumeric/. characters are replaced with a single &#39;-&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^A-Za-z0-9.]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">safe_version</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an arbitrary string to a standard version string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># normalize the version</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">InvalidVersion</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^A-Za-z0-9.]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">safe_extra</span><span class="p">(</span><span class="n">extra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert an arbitrary string to a standard &#39;extra&#39; name</span>

<span class="sd">    Any runs of non-alphanumeric characters are replaced with a single &#39;_&#39;,</span>
<span class="sd">    and the result is always lowercased.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^A-Za-z0-9.-]+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">to_filename</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a project or version name to its filename-escaped form</span>

<span class="sd">    Any &#39;-&#39; characters are currently replaced with &#39;_&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">invalid_marker</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate text as a PEP 508 environment marker; return an exception</span>
<span class="sd">    if invalid or False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">evaluate_marker</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">e</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">evaluate_marker</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a PEP 508 environment marker.</span>
<span class="sd">    Return a boolean indicating the marker result in this environment.</span>
<span class="sd">    Raise SyntaxError if marker is invalid.</span>

<span class="sd">    This implementation uses the &#39;pyparsing&#39; module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">marker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">packaging</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">InvalidMarker</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>


<span class="k">class</span> <span class="nc">NullProvider</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Try to implement resources and metadata for arbitrary PEP 302 loaders&quot;&quot;&quot;</span>

    <span class="n">egg_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">egg_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__loader__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_resource_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_resource_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_resource_string</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_resource_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">has_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_metadata_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># Include the path in the error message to simplify</span>
            <span class="c1"># troubleshooting, and without changing the exception type.</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">reason</span> <span class="o">+=</span> <span class="s1">&#39; in </span><span class="si">{}</span><span class="s1"> file at path: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">get_metadata_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yield_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">resource_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">metadata_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">resource_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">metadata_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;scripts/&#39;</span> <span class="o">+</span> <span class="n">script_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metadata</span><span class="p">(</span><span class="n">script</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ResolutionError</span><span class="p">(</span>
                <span class="s2">&quot;Script </span><span class="si">{script!r}</span><span class="s2"> not found in metadata at </span><span class="si">{self.egg_info!r}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="n">script_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">script_text</span> <span class="o">=</span> <span class="n">script_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">script_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
        <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_filename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">script_filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">linecache</span> <span class="kn">import</span> <span class="n">cache</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">script_filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">script_text</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">script_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">script_filename</span>
            <span class="p">)</span>
            <span class="n">script_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">script_text</span><span class="p">,</span> <span class="n">script_filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">script_code</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Can&#39;t perform this operation for unregistered loader type&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Can&#39;t perform this operation for unregistered loader type&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Can&#39;t perform this operation for unregistered loader type&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_resource_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">resource_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_resource_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the resource paths according to the docs.</span>
<span class="sd">        https://setuptools.readthedocs.io/en/latest/pkg_resources.html#basic-resource-access</span>

<span class="sd">        &gt;&gt;&gt; warned = getfixture(&#39;recwarn&#39;)</span>
<span class="sd">        &gt;&gt;&gt; warnings.simplefilter(&#39;always&#39;)</span>
<span class="sd">        &gt;&gt;&gt; vrp = NullProvider._validate_resource_path</span>
<span class="sd">        &gt;&gt;&gt; vrp(&#39;foo/bar.txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; vrp(&#39;../foo/bar.txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; warned.clear()</span>
<span class="sd">        &gt;&gt;&gt; vrp(&#39;/foo/bar.txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; vrp(&#39;foo/../../bar.txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; warned.clear()</span>
<span class="sd">        &gt;&gt;&gt; vrp(&#39;foo/f../bar.txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        False</span>

<span class="sd">        Windows path separators are straight-up disallowed.</span>
<span class="sd">        &gt;&gt;&gt; vrp(r&#39;\\foo/bar.txt&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: Use of .. or absolute path in a resource path \</span>
<span class="sd">is not allowed.</span>

<span class="sd">        &gt;&gt;&gt; vrp(r&#39;C:\\foo/bar.txt&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ValueError: Use of .. or absolute path in a resource path \</span>
<span class="sd">is not allowed.</span>

<span class="sd">        Blank values are allowed</span>

<span class="sd">        &gt;&gt;&gt; vrp(&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bool(warned)</span>
<span class="sd">        False</span>

<span class="sd">        Non-string values are not.</span>

<span class="sd">        &gt;&gt;&gt; vrp(None)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AttributeError: ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">posixpath</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">posixpath</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">ntpath</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invalid</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Use of .. or absolute path in a resource path is not allowed.&quot;</span>

        <span class="c1"># Aggressively disallow Windows absolute paths</span>
        <span class="k">if</span> <span class="n">ntpath</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># for compatibility, warn; in future</span>
        <span class="c1"># raise ValueError(msg)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; and will raise exceptions in a future release.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;get_data&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Can&#39;t perform this operation for loaders without &#39;get_data()&#39;&quot;</span>
        <span class="p">)</span>


<span class="n">register_loader_type</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">NullProvider</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parents</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    yield all parents of path including path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">path</span> <span class="o">!=</span> <span class="n">last</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">path</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EggProvider</span><span class="p">(</span><span class="n">NullProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provider based on a virtual filesystem&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="n">NullProvider</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_prefix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Assume that metadata may be nested inside a &quot;basket&quot;</span>
        <span class="c1"># of multiple eggs and use module_path instead of .archive.</span>
        <span class="n">eggs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_is_egg_path</span><span class="p">,</span> <span class="n">_parents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">))</span>
        <span class="n">egg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">eggs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">egg</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_egg</span><span class="p">(</span><span class="n">egg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_egg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;EGG-INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egg_root</span> <span class="o">=</span> <span class="n">path</span>


<span class="k">class</span> <span class="nc">DefaultProvider</span><span class="p">(</span><span class="n">EggProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides access to package resources in the filesystem&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_resource_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_register</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">loader_names</span> <span class="o">=</span> <span class="s1">&#39;SourceFileLoader&#39;</span><span class="p">,</span> <span class="s1">&#39;SourcelessFileLoader&#39;</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">loader_names</span><span class="p">:</span>
            <span class="n">loader_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">importlib_machinery</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">register_loader_type</span><span class="p">(</span><span class="n">loader_cls</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>


<span class="n">DefaultProvider</span><span class="o">.</span><span class="n">_register</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">EmptyProvider</span><span class="p">(</span><span class="n">NullProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provider that returns nothing for all requests&quot;&quot;&quot;</span>

    <span class="n">module_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_isdir</span> <span class="o">=</span> <span class="n">_has</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">empty_provider</span> <span class="o">=</span> <span class="n">EmptyProvider</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ZipManifests</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    zip manifest builder</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a dictionary similar to the zipimport directory</span>
<span class="sd">        caches, except instead of tuples, store ZipInfo objects.</span>

<span class="sd">        Use a platform-specific path separator (os.sep) for the path keys</span>
<span class="sd">        for compatibility with pypy on Windows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">zfile</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">),</span>
                    <span class="n">zfile</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zfile</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="n">load</span> <span class="o">=</span> <span class="n">build</span>


<span class="k">class</span> <span class="nc">MemoizedZipManifests</span><span class="p">(</span><span class="n">ZipManifests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Memoized zipfile manifests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manifest_mod</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;manifest_mod&#39;</span><span class="p">,</span> <span class="s1">&#39;manifest mtime&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a manifest at path or return a suitable manifest already loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">mtime</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest_mod</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">manifest</span>


<span class="k">class</span> <span class="nc">ZipProvider</span><span class="p">(</span><span class="n">EggProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resource support for zips and eggs&quot;&quot;&quot;</span>

    <span class="n">eagers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_zip_manifests</span> <span class="o">=</span> <span class="n">MemoizedZipManifests</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="n">EggProvider</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">archive</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

    <span class="k">def</span> <span class="nf">_zipinfo_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">):</span>
        <span class="c1"># Convert a virtual filename (full path to file) into a zipfile subpath</span>
        <span class="c1"># usable with the zipimport directory cache for our target archive</span>
        <span class="n">fspath</span> <span class="o">=</span> <span class="n">fspath</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fspath</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">archive</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fspath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fspath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span><span class="p">):]</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a subpath of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">):</span>
        <span class="c1"># Convert a zipfile subpath into an egg-relative path part list.</span>
        <span class="c1"># pseudo-fs path</span>
        <span class="n">fspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span> <span class="o">+</span> <span class="n">zip_path</span>
        <span class="k">if</span> <span class="n">fspath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_root</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fspath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_root</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a subpath of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fspath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_root</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zipinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zip_manifests</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">archive</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_resource_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">egg_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;resource_filename() only supported for .egg, not .zip&quot;</span>
            <span class="p">)</span>
        <span class="c1"># no need to lock for extraction, since we use temp names</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_to_zip</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="n">eagers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eager_resources</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">zip_path</span><span class="p">))</span> <span class="ow">in</span> <span class="n">eagers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">eagers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extract_resource</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eager_to_zip</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_resource</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_date_and_size</span><span class="p">(</span><span class="n">zip_stat</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">zip_stat</span><span class="o">.</span><span class="n">file_size</span>
        <span class="c1"># ymdhms+wday, yday, dst</span>
        <span class="n">date_time</span> <span class="o">=</span> <span class="n">zip_stat</span><span class="o">.</span><span class="n">date_time</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 1980 offset already done</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">size</span>

    <span class="k">def</span> <span class="nf">_extract_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">zip_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">()[</span><span class="n">zip_path</span><span class="p">]:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_resource</span><span class="p">(</span>
                    <span class="n">manager</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="c1"># return the extracted directory name</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>

        <span class="n">timestamp</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_date_and_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zipinfo</span><span class="p">[</span><span class="n">zip_path</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">WRITE_SUPPORT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;&quot;os.rename&quot; and &quot;os.unlink&quot; are not supported &#39;</span>
                          <span class="s1">&#39;on this platform&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">real_path</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_cache_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">egg_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_current</span><span class="p">(</span><span class="n">real_path</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">real_path</span>

            <span class="n">outf</span><span class="p">,</span> <span class="n">tmpnam</span> <span class="o">=</span> <span class="n">_mkstemp</span><span class="p">(</span>
                <span class="s2">&quot;.$extract&quot;</span><span class="p">,</span>
                <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">real_path</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">zip_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span>
            <span class="n">utime</span><span class="p">(</span><span class="n">tmpnam</span><span class="p">,</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">tmpnam</span><span class="p">,</span> <span class="n">real_path</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rename</span><span class="p">(</span><span class="n">tmpnam</span><span class="p">,</span> <span class="n">real_path</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">real_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_current</span><span class="p">(</span><span class="n">real_path</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">):</span>
                        <span class="c1"># the file became current since it was checked above,</span>
                        <span class="c1">#  so proceed.</span>
                        <span class="k">return</span> <span class="n">real_path</span>
                    <span class="c1"># Windows, del old file and retry</span>
                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
                        <span class="n">unlink</span><span class="p">(</span><span class="n">real_path</span><span class="p">)</span>
                        <span class="n">rename</span><span class="p">(</span><span class="n">tmpnam</span><span class="p">,</span> <span class="n">real_path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">real_path</span>
                <span class="k">raise</span>

        <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="c1"># report a user-friendly error</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">extraction_error</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">real_path</span>

    <span class="k">def</span> <span class="nf">_is_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if the file_path is current for this zip_path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_date_and_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zipinfo</span><span class="p">[</span><span class="n">zip_path</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span> <span class="o">!=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">!=</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># check that the contents match</span>
        <span class="n">zip_contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">zip_contents</span> <span class="o">==</span> <span class="n">file_contents</span>

    <span class="k">def</span> <span class="nf">_get_eager_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eagers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eagers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;native_libs.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;eager_resources.txt&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">eagers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata_lines</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eagers</span> <span class="o">=</span> <span class="n">eagers</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eagers</span>

    <span class="k">def</span> <span class="nf">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirindex</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zipinfo</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">parts</span><span class="p">:</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">:</span>
                        <span class="n">ind</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ind</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirindex</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="k">return</span> <span class="n">ind</span>

    <span class="k">def</span> <span class="nf">_has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">):</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipinfo_name</span><span class="p">(</span><span class="n">fspath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zip_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zipinfo</span> <span class="ow">or</span> <span class="n">zip_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipinfo_name</span><span class="p">(</span><span class="n">fspath</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zipinfo_name</span><span class="p">(</span><span class="n">fspath</span><span class="p">),</span> <span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_eager_to_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipinfo_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">egg_root</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_resource_to_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipinfo_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">))</span>


<span class="n">register_loader_type</span><span class="p">(</span><span class="n">zipimport</span><span class="o">.</span><span class="n">zipimporter</span><span class="p">,</span> <span class="n">ZipProvider</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileMetadata</span><span class="p">(</span><span class="n">EmptyProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metadata handler for standalone PKG-INFO files</span>

<span class="sd">    Usage::</span>

<span class="sd">        metadata = FileMetadata(&quot;/path/to/PKG-INFO&quot;)</span>

<span class="sd">    This provider rejects all data and metadata requests except for PKG-INFO,</span>
<span class="sd">    which is treated as existing, and will be the contents of the file at</span>
<span class="sd">    the provided location.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_get_metadata_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>

    <span class="k">def</span> <span class="nf">has_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;PKG-INFO&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;PKG-INFO&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No metadata except PKG-INFO is available&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_replacement</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">_warn_on_replacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="c1"># Python 2.7 compat for: replacement_char = &#39;&#39;</span>
        <span class="n">replacement_char</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xef\xbf\xbd</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">replacement_char</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">tmpl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{self.path}</span><span class="s2"> could not be properly decoded in UTF-8&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_metadata_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yield_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">PathMetadata</span><span class="p">(</span><span class="n">DefaultProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metadata provider for egg directories</span>

<span class="sd">    Usage::</span>

<span class="sd">        # Development eggs:</span>

<span class="sd">        egg_info = &quot;/path/to/PackageName.egg-info&quot;</span>
<span class="sd">        base_dir = os.path.dirname(egg_info)</span>
<span class="sd">        metadata = PathMetadata(base_dir, egg_info)</span>
<span class="sd">        dist_name = os.path.splitext(os.path.basename(egg_info))[0]</span>
<span class="sd">        dist = Distribution(basedir, project_name=dist_name, metadata=metadata)</span>

<span class="sd">        # Unpacked egg directories:</span>

<span class="sd">        egg_path = &quot;/path/to/PackageName-ver-pyver-etc.egg&quot;</span>
<span class="sd">        metadata = PathMetadata(egg_path, os.path.join(egg_path,&#39;EGG-INFO&#39;))</span>
<span class="sd">        dist = Distribution.from_filename(egg_path, metadata=metadata)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">egg_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egg_info</span> <span class="o">=</span> <span class="n">egg_info</span>


<span class="k">class</span> <span class="nc">EggMetadata</span><span class="p">(</span><span class="n">ZipProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metadata provider for .egg files&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a metadata provider from a zipimporter&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zip_pre</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">archive</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">importer</span>
        <span class="k">if</span> <span class="n">importer</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span> <span class="n">importer</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">archive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_prefix</span><span class="p">()</span>


<span class="n">_declare_state</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">_distribution_finders</span><span class="o">=</span><span class="p">{})</span>


<span class="k">def</span> <span class="nf">register_finder</span><span class="p">(</span><span class="n">importer_type</span><span class="p">,</span> <span class="n">distribution_finder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register `distribution_finder` to find distributions in sys.path items</span>

<span class="sd">    `importer_type` is the type or class of a PEP 302 &quot;Importer&quot; (sys.path item</span>
<span class="sd">    handler), and `distribution_finder` is a callable that, passed a path</span>
<span class="sd">    item and the importer instance, yields ``Distribution`` instances found on</span>
<span class="sd">    that path item.  See ``pkg_resources.find_on_path`` for an example.&quot;&quot;&quot;</span>
    <span class="n">_distribution_finders</span><span class="p">[</span><span class="n">importer_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">distribution_finder</span>


<span class="k">def</span> <span class="nf">find_distributions</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield distributions accessible via `path_item`&quot;&quot;&quot;</span>
    <span class="n">importer</span> <span class="o">=</span> <span class="n">get_importer</span><span class="p">(</span><span class="n">path_item</span><span class="p">)</span>
    <span class="n">finder</span> <span class="o">=</span> <span class="n">_find_adapter</span><span class="p">(</span><span class="n">_distribution_finders</span><span class="p">,</span> <span class="n">importer</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">finder</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_eggs_in_zip</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find eggs in zip files; possibly multiple nested eggs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">importer</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.whl&#39;</span><span class="p">):</span>
        <span class="c1"># wheels are not supported with this finder</span>
        <span class="c1"># they don&#39;t have PKG-INFO metadata, and won&#39;t ever contain eggs</span>
        <span class="k">return</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">EggMetadata</span><span class="p">(</span><span class="n">importer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">has_metadata</span><span class="p">(</span><span class="s1">&#39;PKG-INFO&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
        <span class="c1"># don&#39;t yield nested distros</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">resource_listdir</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_is_egg_path</span><span class="p">(</span><span class="n">subitem</span><span class="p">):</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">subitem</span><span class="p">)</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">find_eggs_in_zip</span><span class="p">(</span><span class="n">zipimport</span><span class="o">.</span><span class="n">zipimporter</span><span class="p">(</span><span class="n">subpath</span><span class="p">),</span> <span class="n">subpath</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dist</span>
        <span class="k">elif</span> <span class="n">subitem</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.dist-info&#39;</span><span class="p">):</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">subitem</span><span class="p">)</span>
            <span class="n">submeta</span> <span class="o">=</span> <span class="n">EggMetadata</span><span class="p">(</span><span class="n">zipimport</span><span class="o">.</span><span class="n">zipimporter</span><span class="p">(</span><span class="n">subpath</span><span class="p">))</span>
            <span class="n">submeta</span><span class="o">.</span><span class="n">egg_info</span> <span class="o">=</span> <span class="n">subpath</span>
            <span class="k">yield</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_location</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">subitem</span><span class="p">,</span> <span class="n">submeta</span><span class="p">)</span>


<span class="n">register_finder</span><span class="p">(</span><span class="n">zipimport</span><span class="o">.</span><span class="n">zipimporter</span><span class="p">,</span> <span class="n">find_eggs_in_zip</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_nothing</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">()</span>


<span class="n">register_finder</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">find_nothing</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_by_version_descending</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of filenames, return them in descending order</span>
<span class="sd">    by version number.</span>

<span class="sd">    &gt;&gt;&gt; names = &#39;bar&#39;, &#39;foo&#39;, &#39;Python-2.7.10.egg&#39;, &#39;Python-2.7.2.egg&#39;</span>
<span class="sd">    &gt;&gt;&gt; _by_version_descending(names)</span>
<span class="sd">    [&#39;Python-2.7.10.egg&#39;, &#39;Python-2.7.2.egg&#39;, &#39;foo&#39;, &#39;bar&#39;]</span>
<span class="sd">    &gt;&gt;&gt; names = &#39;Setuptools-1.2.3b1.egg&#39;, &#39;Setuptools-1.2.3.egg&#39;</span>
<span class="sd">    &gt;&gt;&gt; _by_version_descending(names)</span>
<span class="sd">    [&#39;Setuptools-1.2.3.egg&#39;, &#39;Setuptools-1.2.3b1.egg&#39;]</span>
<span class="sd">    &gt;&gt;&gt; names = &#39;Setuptools-1.2.3b1.egg&#39;, &#39;Setuptools-1.2.3.post1.egg&#39;</span>
<span class="sd">    &gt;&gt;&gt; _by_version_descending(names)</span>
<span class="sd">    [&#39;Setuptools-1.2.3.post1.egg&#39;, &#39;Setuptools-1.2.3b1.egg&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_by_version</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse each component of the filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">ext</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_by_version</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_on_path</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield distributions accessible on a sys.path directory&quot;&quot;&quot;</span>
    <span class="n">path_item</span> <span class="o">=</span> <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">path_item</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_is_unpacked_egg</span><span class="p">(</span><span class="n">path_item</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span>
            <span class="n">path_item</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">PathMetadata</span><span class="p">(</span>
                <span class="n">path_item</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="s1">&#39;EGG-INFO&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="n">safe_listdir</span><span class="p">(</span><span class="n">path_item</span><span class="p">)</span>

    <span class="c1"># for performance, before sorting by version,</span>
    <span class="c1"># screen entries for only those that will yield</span>
    <span class="c1"># distributions</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">entry</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="n">dist_factory</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># scan for .egg and .egg-info in directory</span>
    <span class="n">path_item_entries</span> <span class="o">=</span> <span class="n">_by_version_descending</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">path_item_entries</span><span class="p">:</span>
        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">dist_factory</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">factory</span><span class="p">(</span><span class="n">fullpath</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">dist</span>


<span class="k">def</span> <span class="nf">dist_factory</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">only</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a dist_factory for the given entry.&quot;&quot;&quot;</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">is_egg_info</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.egg-info&#39;</span><span class="p">)</span>
    <span class="n">is_dist_info</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.dist-info&#39;</span><span class="p">)</span> <span class="ow">and</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">is_meta</span> <span class="o">=</span> <span class="n">is_egg_info</span> <span class="ow">or</span> <span class="n">is_dist_info</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">distributions_from_metadata</span>
        <span class="k">if</span> <span class="n">is_meta</span> <span class="k">else</span>
        <span class="n">find_distributions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only</span> <span class="ow">and</span> <span class="n">_is_egg_path</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">else</span>
        <span class="n">resolve_egg_link</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only</span> <span class="ow">and</span> <span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.egg-link&#39;</span><span class="p">)</span> <span class="k">else</span>
        <span class="n">NoDists</span><span class="p">()</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">NoDists</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; bool(NoDists())</span>
<span class="sd">    False</span>

<span class="sd">    &gt;&gt;&gt; list(NoDists()(&#39;anything&#39;))</span>
<span class="sd">    []</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
        <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>


<span class="k">def</span> <span class="nf">safe_listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to list contents of path, but suppress some exceptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="ne">NotADirectoryError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Ignore the directory if does not exist, not a directory or</span>
        <span class="c1"># permission denied</span>
        <span class="n">ignorable</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOTDIR</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
            <span class="c1"># Python 2 on Windows needs to be handled this way :(</span>
            <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;winerror&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">267</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignorable</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="p">()</span>


<span class="k">def</span> <span class="nf">distributions_from_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># empty metadata dir; skip</span>
            <span class="k">return</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">PathMetadata</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">FileMetadata</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_location</span><span class="p">(</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">precedence</span><span class="o">=</span><span class="n">DEVELOP_DIST</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">non_empty_lines</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield non-empty lines from file at path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">resolve_egg_link</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a path to an .egg-link, resolve distributions</span>
<span class="sd">    present in the referenced path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">referenced_paths</span> <span class="o">=</span> <span class="n">non_empty_lines</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">resolved_paths</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">ref</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">referenced_paths</span>
    <span class="p">)</span>
    <span class="n">dist_groups</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">find_distributions</span><span class="p">,</span> <span class="n">resolved_paths</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">dist_groups</span><span class="p">,</span> <span class="p">())</span>


<span class="n">register_finder</span><span class="p">(</span><span class="n">pkgutil</span><span class="o">.</span><span class="n">ImpImporter</span><span class="p">,</span> <span class="n">find_on_path</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">importlib_machinery</span><span class="p">,</span> <span class="s1">&#39;FileFinder&#39;</span><span class="p">):</span>
    <span class="n">register_finder</span><span class="p">(</span><span class="n">importlib_machinery</span><span class="o">.</span><span class="n">FileFinder</span><span class="p">,</span> <span class="n">find_on_path</span><span class="p">)</span>

<span class="n">_declare_state</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">_namespace_handlers</span><span class="o">=</span><span class="p">{})</span>
<span class="n">_declare_state</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">_namespace_packages</span><span class="o">=</span><span class="p">{})</span>


<span class="k">def</span> <span class="nf">register_namespace_handler</span><span class="p">(</span><span class="n">importer_type</span><span class="p">,</span> <span class="n">namespace_handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register `namespace_handler` to declare namespace packages</span>

<span class="sd">    `importer_type` is the type or class of a PEP 302 &quot;Importer&quot; (sys.path item</span>
<span class="sd">    handler), and `namespace_handler` is a callable like this::</span>

<span class="sd">        def namespace_handler(importer, path_entry, moduleName, module):</span>
<span class="sd">            # return a path_entry to use for child packages</span>

<span class="sd">    Namespace handlers are only called if the importer object has already</span>
<span class="sd">    agreed that it can handle the relevant path item, and they should only</span>
<span class="sd">    return a subpath if the module __path__ does not already contain an</span>
<span class="sd">    equivalent subpath.  For an example namespace handler, see</span>
<span class="sd">    ``pkg_resources.file_ns_handler``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_namespace_handlers</span><span class="p">[</span><span class="n">importer_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">namespace_handler</span>


<span class="k">def</span> <span class="nf">_handle_ns</span><span class="p">(</span><span class="n">packageName</span><span class="p">,</span> <span class="n">path_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that named package includes a subpath of path_item (if needed)&quot;&quot;&quot;</span>

    <span class="n">importer</span> <span class="o">=</span> <span class="n">get_importer</span><span class="p">(</span><span class="n">path_item</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">importer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># use find_spec (PEP 451) and fall-back to find_module (PEP 302)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span><span class="o">.</span><span class="n">loader</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># capture warnings due to #1111</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">packageName</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_set_parent_ns</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__path__&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a package:&quot;</span><span class="p">,</span> <span class="n">packageName</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">_find_adapter</span><span class="p">(</span><span class="n">_namespace_handlers</span><span class="p">,</span> <span class="n">importer</span><span class="p">)</span>
    <span class="n">subpath</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">packageName</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
        <span class="n">_rebuild_mod_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">packageName</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subpath</span>


<span class="k">def</span> <span class="nf">_rebuild_mod_path</span><span class="p">(</span><span class="n">orig_path</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rebuild module.__path__ ensuring that all entries are ordered</span>
<span class="sd">    corresponding to their sys.path order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">_normalize_cached</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">safe_sys_path_index</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workaround for #520 and #513.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sys_path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">position_in_sys_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ordinal of the path based on its position in sys.path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">module_parts</span> <span class="o">=</span> <span class="n">package_name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[:</span><span class="o">-</span><span class="n">module_parts</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">safe_sys_path_index</span><span class="p">(</span><span class="n">_normalize_cached</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)))</span>

    <span class="n">new_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">orig_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">position_in_sys_path</span><span class="p">)</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">_normalize_cached</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">new_path</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="n">new_path</span>


<span class="k">def</span> <span class="nf">declare_namespace</span><span class="p">(</span><span class="n">packageName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Declare that package &#39;packageName&#39; is a namespace package&quot;&quot;&quot;</span>

    <span class="n">_imp</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">packageName</span> <span class="ow">in</span> <span class="n">_namespace_packages</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">declare_namespace</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_namespace_packages</span><span class="p">:</span>
                <span class="nb">__import__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">__path__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a package:&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Track what packages are namespaces, so when new path items are added,</span>
        <span class="c1"># they can be updated</span>
        <span class="n">_namespace_packages</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">parent</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>
        <span class="n">_namespace_packages</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">packageName</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">path_item</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># Ensure all the parent&#39;s path items are reflected in the child,</span>
            <span class="c1"># if they apply</span>
            <span class="n">_handle_ns</span><span class="p">(</span><span class="n">packageName</span><span class="p">,</span> <span class="n">path_item</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_imp</span><span class="o">.</span><span class="n">release_lock</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">fixup_namespace_packages</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that previously-declared namespace packages include path_item&quot;&quot;&quot;</span>
    <span class="n">_imp</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">_namespace_packages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="n">_handle_ns</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">path_item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subpath</span><span class="p">:</span>
                <span class="n">fixup_namespace_packages</span><span class="p">(</span><span class="n">subpath</span><span class="p">,</span> <span class="n">package</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_imp</span><span class="o">.</span><span class="n">release_lock</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">file_ns_handler</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">packageName</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute an ns-package subpath for a filesystem or zipfile importer&quot;&quot;&quot;</span>

    <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_item</span><span class="p">,</span> <span class="n">packageName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Only return the path if it&#39;s not already there</span>
        <span class="k">return</span> <span class="n">subpath</span>


<span class="n">register_namespace_handler</span><span class="p">(</span><span class="n">pkgutil</span><span class="o">.</span><span class="n">ImpImporter</span><span class="p">,</span> <span class="n">file_ns_handler</span><span class="p">)</span>
<span class="n">register_namespace_handler</span><span class="p">(</span><span class="n">zipimport</span><span class="o">.</span><span class="n">zipimporter</span><span class="p">,</span> <span class="n">file_ns_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">importlib_machinery</span><span class="p">,</span> <span class="s1">&#39;FileFinder&#39;</span><span class="p">):</span>
    <span class="n">register_namespace_handler</span><span class="p">(</span><span class="n">importlib_machinery</span><span class="o">.</span><span class="n">FileFinder</span><span class="p">,</span> <span class="n">file_ns_handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">null_ns_handler</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">path_item</span><span class="p">,</span> <span class="n">packageName</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="n">register_namespace_handler</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">null_ns_handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalize a file/dir name for comparison purposes&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
        <span class="n">_cygwin_patch</span><span class="p">(</span><span class="n">filename</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">_cygwin_patch</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contrary to POSIX 2008, on Cygwin, getcwd (3) contains</span>
<span class="sd">    symlink components. Using</span>
<span class="sd">    os.path.abspath() works around this limitation. A fix in os.getcwd()</span>
<span class="sd">    would probably better, in Cygwin even more so, except</span>
<span class="sd">    that this seems to be by design...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;cygwin&#39;</span> <span class="k">else</span> <span class="n">filename</span>


<span class="k">def</span> <span class="nf">_normalize_cached</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">_cache</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_is_egg_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if given path appears to be an egg.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.egg&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_unpacked_egg</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if given path appears to be an unpacked egg.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">_is_egg_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;EGG-INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;PKG-INFO&#39;</span><span class="p">))</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_set_parent_ns</span><span class="p">(</span><span class="n">packageName</span><span class="p">):</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">packageName</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">yield_lines</span><span class="p">(</span><span class="n">strs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield non-empty/non-comment lines of a string or sequence&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strs</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strs</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># skip blank lines/comments</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">yield_lines</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">s</span>


<span class="n">MODULE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+(\.\w+)*$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
<span class="n">EGG_NAME</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (?P&lt;name&gt;[^-]+) (</span>
<span class="sd">        -(?P&lt;ver&gt;[^-]+) (</span>
<span class="sd">            -py(?P&lt;pyver&gt;[^-]+) (</span>
<span class="sd">                -(?P&lt;plat&gt;.+)</span>
<span class="sd">            )?</span>
<span class="sd">        )?</span>
<span class="sd">    )?</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">match</span>


<span class="k">class</span> <span class="nc">EntryPoint</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Object representing an advertised importable object&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">(),</span> <span class="n">extras</span><span class="o">=</span><span class="p">(),</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MODULE</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid module name&quot;</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extras</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;EntryPoint.parse(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Require packages for this EntryPoint, then resolve it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">require</span> <span class="ow">or</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Parameters to load are deprecated.  Call .resolve and &quot;</span>
                <span class="s2">&quot;.require separately.&quot;</span><span class="p">,</span>
                <span class="n">PkgResourcesDeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">require</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve the entry point from its module and attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="k">def</span> <span class="nf">require</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownExtra</span><span class="p">(</span><span class="s2">&quot;Can&#39;t require() without a distribution&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Get the requirements for this entry point with all its extras and</span>
        <span class="c1"># then resolve them. We have to pass `extras` along when resolving so</span>
        <span class="c1"># that the working set knows what extras we want. Otherwise, for</span>
        <span class="c1"># dist-info distributions, the working set will assume that the</span>
        <span class="c1"># requirements for that extra are purely optional and skip over them.</span>
        <span class="n">reqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">reqs</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">installer</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">working_set</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;\s*&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;name&gt;.+?)\s*&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;=\s*&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;module&gt;[\w.]+)\s*&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(:\s*(?P&lt;attr&gt;[\w.]+))?\s*&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;extras&gt;\[.*\])?\s*$&#39;</span>
    <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a single entry point from string `src`</span>

<span class="sd">        Entry point syntax follows the form::</span>

<span class="sd">            name = some.module:some.attr [extra1, extra2]</span>

<span class="sd">        The entry name and module name are required, but the ``:attrs`` and</span>
<span class="sd">        ``[extras]`` parts are optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;EntryPoint must be in &#39;name=module:attrs [extras]&#39; format&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_extras</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">])</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">extras</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">extras_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extras_spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="n">extras_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">extras</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_group</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse an entry point group&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MODULE</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid group name&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">this</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">yield_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ep</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">this</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate entry point&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">this</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span>
        <span class="k">return</span> <span class="n">this</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a map of entry point groups&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">split_sections</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Entry points must be listed in groups&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate group name&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="n">maps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maps</span>


<span class="k">def</span> <span class="nf">_version_from_file</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an iterable of lines from a Metadata file, return</span>
<span class="sd">    the value of the Version field, if present, or None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">is_version_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;version:&#39;</span><span class="p">)</span>
    <span class="n">version_lines</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">is_version_line</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">version_lines</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">safe_version</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">or</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Distribution</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrap an actual or potential sys.path entry w/metadata&quot;&quot;&quot;</span>
    <span class="n">PKG_INFO</span> <span class="o">=</span> <span class="s1">&#39;PKG-INFO&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">py_version</span><span class="o">=</span><span class="n">PY_MAJOR</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">precedence</span><span class="o">=</span><span class="n">EGG_DIST</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">safe_name</span><span class="p">(</span><span class="n">project_name</span> <span class="ow">or</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">safe_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">py_version</span> <span class="o">=</span> <span class="n">py_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="n">precedence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="n">empty_provider</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_location</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">project_name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">py_version</span><span class="p">,</span> <span class="n">platform</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_distributionImpl</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">_distributionImpl</span><span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

            <span class="n">match</span> <span class="o">=</span> <span class="n">EGG_NAME</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">project_name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">py_version</span><span class="p">,</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ver&#39;</span><span class="p">,</span> <span class="s1">&#39;pyver&#39;</span><span class="p">,</span> <span class="s1">&#39;plat&#39;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">location</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">py_version</span><span class="o">=</span><span class="n">py_version</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span><span class="o">.</span><span class="n">_reload_version</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reload_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hashcmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">py_version</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">hashcmp</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">hashcmp</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">hashcmp</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">hashcmp</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="c1"># It&#39;s not a Distribution, so they are not equal</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcmp</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">hashcmp</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="c1"># These properties have to be lazy so that we don&#39;t have to load any</span>
    <span class="c1"># metadata until/unless it&#39;s actually needed.  (i.e., some distributions</span>
    <span class="c1"># may not know their name or version without loading PKG-INFO)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parsed_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_parsed_version&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_version</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_version</span>

    <span class="k">def</span> <span class="nf">_warn_legacy_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LV</span> <span class="o">=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">LegacyVersion</span>
        <span class="n">is_legacy</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed_version</span><span class="p">,</span> <span class="n">LV</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_legacy</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># While an empty version is technically a legacy version and</span>
        <span class="c1"># is not a valid PEP 440 version, it&#39;s also unlikely to</span>
        <span class="c1"># actually come from someone and instead it is more likely that</span>
        <span class="c1"># it comes from setuptools attempting to parse a filename and</span>
        <span class="c1"># including it in the list. So for that we&#39;ll gate this warning</span>
        <span class="c1"># on if the version is anything at all or not.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &#39;</span><span class="si">{project_name}</span><span class="s2"> (</span><span class="si">{version}</span><span class="s2">)&#39; is being parsed as a legacy,</span>
<span class="s2">            non PEP 440,</span>
<span class="s2">            version. You may find odd behavior and sort order.</span>
<span class="s2">            In particular it will be sorted as less than 0.0. It</span>
<span class="s2">            is recommended to migrate to PEP 440 compatible</span>
<span class="s2">            versions.</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">tmpl</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="n">PEP440Warning</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_path_for_display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PKG_INFO</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Missing &#39;Version:&#39; header and/or </span><span class="si">{}</span><span class="s2"> file at path: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PKG_INFO</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="k">return</span> <span class="n">version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_dep_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A map of extra to its list of (direct) requirements</span>
<span class="sd">        for this distribution, including the null extra.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_extras</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_dep_map</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_filter_extras</span><span class="p">(</span><span class="n">dm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a mapping of extras to dependencies, strip off</span>
<span class="sd">        environment markers and filter out any dependencies</span>
<span class="sd">        not matching the markers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm</span><span class="p">)):</span>
            <span class="n">new_extra</span> <span class="o">=</span> <span class="n">extra</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
            <span class="n">new_extra</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">fails_marker</span> <span class="o">=</span> <span class="n">marker</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">invalid_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">evaluate_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fails_marker</span><span class="p">:</span>
                <span class="n">reqs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_extra</span> <span class="o">=</span> <span class="n">safe_extra</span><span class="p">(</span><span class="n">new_extra</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

            <span class="n">dm</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_extra</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reqs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dm</span>

    <span class="k">def</span> <span class="nf">_build_dep_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s1">&#39;requires.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;depends.txt&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extra</span><span class="p">,</span> <span class="n">reqs</span> <span class="ow">in</span> <span class="n">split_sections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">dm</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parse_requirements</span><span class="p">(</span><span class="n">reqs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dm</span>

    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;List of Requirements needed for this distro if `extras` are used&quot;&quot;&quot;</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dep_map</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">safe_extra</span><span class="p">(</span><span class="n">ext</span><span class="p">)])</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnknownExtra</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no such extra feature </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">deps</span>

    <span class="k">def</span> <span class="nf">_get_metadata_path_for_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the path to the given metadata file, if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We need to access _get_metadata_path() on the provider object</span>
            <span class="c1"># directly rather than through this class&#39;s __getattr__()</span>
            <span class="c1"># since _get_metadata_path() is marked private.</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="o">.</span><span class="n">_get_metadata_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Handle exceptions e.g. in case the distribution&#39;s metadata</span>
        <span class="c1"># provider doesn&#39;t support _get_metadata_path().</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;[could not detect]&#39;</span>

        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metadata</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata_lines</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PKG_INFO</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">_version_from_file</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">version</span>

    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure distribution is importable on `path` (default=sys.path)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_on</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">fixup_namespace_packages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="s1">&#39;namespace_packages.txt&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                    <span class="n">declare_namespace</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">egg_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return what this distribution&#39;s standard .egg filename should be&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">-py</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">to_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">),</span> <span class="n">to_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">py_version</span> <span class="ow">or</span> <span class="n">PY_MAJOR</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="ow">or</span> <span class="s2">&quot;[unknown version]&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delegate all unrecognized public attributes to .metadata provider&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Distribution</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">())</span>
            <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;__dir__&#39;</span><span class="p">):</span>
        <span class="c1"># python 2.7 not supported</span>
        <span class="k">del</span> <span class="fm">__dir__</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_location</span><span class="p">(</span>
            <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">metadata</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a ``Requirement`` that matches this distribution exactly&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_version</span><span class="p">,</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">Version</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">==</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">===</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_version</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_entry_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the `name` entry point of `group` or raise ImportError&quot;&quot;&quot;</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entry_info</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Entry point </span><span class="si">%r</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">),))</span>
        <span class="k">return</span> <span class="n">ep</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_entry_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the entry point map for `group`, or the full entry map&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ep_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep_map</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">ep_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep_map</span> <span class="o">=</span> <span class="n">EntryPoint</span><span class="o">.</span><span class="n">parse_map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="s1">&#39;entry_points.txt&#39;</span><span class="p">),</span> <span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ep_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">ep_map</span>

    <span class="k">def</span> <span class="nf">get_entry_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the EntryPoint object for `group`+`name`, or ``None``&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entry_map</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure self.location is on path</span>

<span class="sd">        If replace=False (default):</span>
<span class="sd">            - If location is already in path anywhere, do nothing.</span>
<span class="sd">            - Else:</span>
<span class="sd">              - If it&#39;s an egg and its parent directory is on path,</span>
<span class="sd">                insert just ahead of the parent.</span>
<span class="sd">              - Else: add to the end of path.</span>
<span class="sd">        If replace=True:</span>
<span class="sd">            - If location is already on path anywhere (not eggs)</span>
<span class="sd">              or higher priority than its parent (eggs)</span>
<span class="sd">              do nothing.</span>
<span class="sd">            - Else:</span>
<span class="sd">              - If it&#39;s an egg and its parent directory is on path,</span>
<span class="sd">                insert just ahead of the parent,</span>
<span class="sd">                removing any lower-priority entries.</span>
<span class="sd">              - Else: add it to the front of path.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loc</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">nloc</span> <span class="o">=</span> <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">bdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nloc</span><span class="p">)</span>
        <span class="n">npath</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">_normalize_cached</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">npath</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">nloc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># don&#39;t modify path (even removing duplicates) if</span>
                    <span class="c1"># found and not replace</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="n">bdir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span> <span class="o">==</span> <span class="n">EGG_DIST</span><span class="p">:</span>
                <span class="c1"># if it&#39;s an .egg, give it precedence over its directory</span>
                <span class="c1"># UNLESS it&#39;s already been added to sys.path and replace=False</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">replace</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nloc</span> <span class="ow">in</span> <span class="n">npath</span><span class="p">[</span><span class="n">p</span><span class="p">:]:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_version_conflict</span><span class="p">()</span>
                <span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                <span class="n">npath</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nloc</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_version_conflict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># p is the spot where we found or inserted loc; now remove duplicates</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="n">npath</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nloc</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">npath</span><span class="p">[</span><span class="n">np</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">np</span><span class="p">]</span>
                <span class="c1"># ha!</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">check_version_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;setuptools&#39;</span><span class="p">:</span>
            <span class="c1"># ignore the inevitable setuptools self-conflicts  :(</span>
            <span class="k">return</span>

        <span class="n">nsp</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="s1">&#39;namespace_packages.txt&#39;</span><span class="p">))</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">(</span><span class="s1">&#39;top_level.txt&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">modname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="ow">or</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">nsp</span>
                    <span class="ow">or</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">_namespace_packages</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">modname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;pkg_resources&#39;</span><span class="p">,</span> <span class="s1">&#39;setuptools&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">],</span> <span class="s1">&#39;__file__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">normalize_path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="ow">or</span>
                       <span class="n">fn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">issue_warning</span><span class="p">(</span>
                <span class="s2">&quot;Module </span><span class="si">%s</span><span class="s2"> was already imported from </span><span class="si">%s</span><span class="s2">, but </span><span class="si">%s</span><span class="s2"> is being added&quot;</span>
                <span class="s2">&quot; to sys.path&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">issue_warning</span><span class="p">(</span><span class="s2">&quot;Unbuilt egg for &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy this distribution, substituting in any changed keyword args&quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="s1">&#39;project_name version py_version platform location precedence&#39;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dep</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dep_map</span> <span class="k">if</span> <span class="n">dep</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">EggInfoDistribution</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_reload_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Packages installed by distutils (e.g. numpy or scipy),</span>
<span class="sd">        which uses an old safe_version, and so</span>
<span class="sd">        their version numbers can get mangled when</span>
<span class="sd">        converted to filenames (e.g., 1.11.0.dev0+2329eae to</span>
<span class="sd">        1.11.0.dev0_2329eae). These distributions will not be</span>
<span class="sd">        parsed properly</span>
<span class="sd">        downstream by Distribution and safe_version, so</span>
<span class="sd">        take an extra step and try to get the version number from</span>
<span class="sd">        the metadata file itself instead of the filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">md_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">md_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">md_version</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">DistInfoDistribution</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap an actual or potential sys.path entry</span>
<span class="sd">    w/metadata, .dist-info style.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PKG_INFO</span> <span class="o">=</span> <span class="s1">&#39;METADATA&#39;</span>
    <span class="n">EQEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([\(,])\s*(\d.*?)\s*([,\)])&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_parsed_pkg_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse and cache metadata&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_info</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PKG_INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_info</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">Parser</span><span class="p">()</span><span class="o">.</span><span class="n">parsestr</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_dep_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dependencies</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span>

    <span class="k">def</span> <span class="nf">_compute_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recompute this distribution&#39;s dependencies.&quot;&quot;&quot;</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dep_map</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">reqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Including any condition expressions</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_pkg_info</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;Requires-Dist&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">reqs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parse_requirements</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">reqs_for_extra</span><span class="p">(</span><span class="n">extra</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">reqs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span> <span class="ow">or</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">({</span><span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="n">extra</span><span class="p">}):</span>
                    <span class="k">yield</span> <span class="n">req</span>

        <span class="n">common</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">reqs_for_extra</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">dm</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_pkg_info</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s1">&#39;Provides-Extra&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">s_extra</span> <span class="o">=</span> <span class="n">safe_extra</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">dm</span><span class="p">[</span><span class="n">s_extra</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">reqs_for_extra</span><span class="p">(</span><span class="n">extra</span><span class="p">))</span> <span class="o">-</span> <span class="n">common</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dm</span>


<span class="n">_distributionImpl</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;.egg&#39;</span><span class="p">:</span> <span class="n">Distribution</span><span class="p">,</span>
    <span class="s1">&#39;.egg-info&#39;</span><span class="p">:</span> <span class="n">EggInfoDistribution</span><span class="p">,</span>
    <span class="s1">&#39;.dist-info&#39;</span><span class="p">:</span> <span class="n">DistInfoDistribution</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">issue_warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># find the first stack frame that is *not* code in</span>
        <span class="c1"># the pkg_resources module, to use for the warning</span>
        <span class="k">while</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span> <span class="ow">is</span> <span class="n">g</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">stacklevel</span><span class="o">=</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_requirements</span><span class="p">(</span><span class="n">strs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield ``Requirement`` objects for each specification in `strs`</span>

<span class="sd">    `strs` must be a string, or a (possibly-nested) iterable thereof.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create a steppable iterator, so we can handle \-continuations</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">yield_lines</span><span class="p">(</span><span class="n">strs</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># Drop comments -- a hash without a space may be in a URL.</span>
        <span class="k">if</span> <span class="s1">&#39; #&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; #&#39;</span><span class="p">)]</span>
        <span class="c1"># If there is a line continuation, drop it, and append the next line.</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">yield</span> <span class="n">Requirement</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RequirementParseError</span><span class="p">(</span><span class="n">packaging</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">InvalidRequirement</span><span class="p">):</span>
    <span class="s2">&quot;Compatibility wrapper for InvalidRequirement&quot;</span>


<span class="k">class</span> <span class="nc">Requirement</span><span class="p">(</span><span class="n">packaging</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">Requirement</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirement_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DO NOT CALL THIS UNDOCUMENTED METHOD; use Requirement.parse()!&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Requirement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">requirement_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsafe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="n">safe_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specifier</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">safe_extra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashCmp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specifier</span><span class="p">,</span>
            <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marker</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashCmp</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Requirement</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hashCmp</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">hashCmp</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">version</span>

        <span class="c1"># Allow prereleases always in order to match the previous behavior of</span>
        <span class="c1"># this method. In the future this should be smarter and follow PEP 440</span>
        <span class="c1"># more accurately.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">specifier</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">prereleases</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Requirement.parse(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">req</span><span class="p">,</span> <span class="o">=</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span>


<span class="k">def</span> <span class="nf">_always_object</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure object appears in the mro even</span>
<span class="sd">    for old-style classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">object</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">classes</span> <span class="o">+</span> <span class="p">(</span><span class="nb">object</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">classes</span>


<span class="k">def</span> <span class="nf">_find_adapter</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">ob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an adapter factory for `ob` from `registry`&quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">_always_object</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ob</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">registry</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">ensure_directory</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that the parent directory of `path` exists&quot;&quot;&quot;</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_bypass_ensure_directory</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sandbox-bypassing version of ensure_directory()&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">WRITE_SUPPORT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;&quot;os.mkdir&quot; not supported on this platform.&#39;</span><span class="p">)</span>
    <span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirname</span> <span class="ow">and</span> <span class="n">filename</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">_bypass_ensure_directory</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">split_sections</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Split a string or iterable thereof into (section, content) pairs</span>

<span class="sd">    Each ``section`` is a stripped version of the section header (&quot;[section]&quot;)</span>
<span class="sd">    and each ``content`` is a list of stripped lines excluding blank lines and</span>
<span class="sd">    comment-only lines.  If there are any such lines before the first section</span>
<span class="sd">    header, they&#39;re returned in a first ``section`` of ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">section</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">yield_lines</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">or</span> <span class="n">content</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">section</span><span class="p">,</span> <span class="n">content</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid section heading&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># wrap up last segment</span>
    <span class="k">yield</span> <span class="n">section</span><span class="p">,</span> <span class="n">content</span>


<span class="k">def</span> <span class="nf">_mkstemp</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">old_open</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># temporarily bypass sandboxing</span>
        <span class="n">os</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">os_open</span>
        <span class="k">return</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># and then put it back</span>
        <span class="n">os</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">old_open</span>


<span class="c1"># Silence the PEP440Warning by default, so that end users don&#39;t get hit by it</span>
<span class="c1"># randomly just because they use pkg_resources. We want to append the rule</span>
<span class="c1"># because we want earlier uses of filterwarnings to take precedence over this</span>
<span class="c1"># one.</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">PEP440Warning</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># from jaraco.functools 1.3</span>
<span class="k">def</span> <span class="nf">_call_aside</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="nd">@_call_aside</span>
<span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="nb">globals</span><span class="p">()):</span>
    <span class="s2">&quot;Set up global resource manager (deliberately not state-saved)&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>
    <span class="n">g</span><span class="p">[</span><span class="s1">&#39;_manager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manager</span>
    <span class="n">g</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="nd">@_call_aside</span>
<span class="k">def</span> <span class="nf">_initialize_master_working_set</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the master working set and make the ``require()``</span>
<span class="sd">    API available.</span>

<span class="sd">    This function has explicit effects on the global state</span>
<span class="sd">    of pkg_resources. It is intended to be invoked once at</span>
<span class="sd">    the initialization of this module.</span>

<span class="sd">    Invocation by other packages is unsupported and done</span>
<span class="sd">    at their own risk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">working_set</span> <span class="o">=</span> <span class="n">WorkingSet</span><span class="o">.</span><span class="n">_build_master</span><span class="p">()</span>
    <span class="n">_declare_state</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">working_set</span><span class="o">=</span><span class="n">working_set</span><span class="p">)</span>

    <span class="n">require</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">require</span>
    <span class="n">iter_entry_points</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">iter_entry_points</span>
    <span class="n">add_activation_listener</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">subscribe</span>
    <span class="n">run_script</span> <span class="o">=</span> <span class="n">working_set</span><span class="o">.</span><span class="n">run_script</span>
    <span class="c1"># backward compatibility</span>
    <span class="n">run_main</span> <span class="o">=</span> <span class="n">run_script</span>
    <span class="c1"># Activate all distributions already on sys.path with replace=False and</span>
    <span class="c1"># ensure that all distributions added to the working set in the future</span>
    <span class="c1"># (e.g. by calling ``require()``) will get activated as well,</span>
    <span class="c1"># with higher priority (replace=True).</span>
    <span class="nb">tuple</span><span class="p">(</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">working_set</span>
    <span class="p">)</span>
    <span class="n">add_activation_listener</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">dist</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">working_set</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># match order</span>
    <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">working_set</span><span class="o">.</span><span class="n">add_entry</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">PkgResourcesDeprecationWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for warning about deprecations in ``pkg_resources``</span>

<span class="sd">    This class is not derived from ``DeprecationWarning``, and as such is</span>
<span class="sd">    visible by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, MetPy Developers. Development supported by National Science Foundation grants AGS-1344155, OAC-1740315, and AGS-1901712..
      Last updated on Aug 06, 2020 at 20:22:57.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92978945-1', 'auto');
  ga('send', 'pageview');
</script>
<script>var version_json_loc = "../../versions.json";</script>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.12.2',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>
      <script type="text/javascript" src="../_static/pop_ver.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>